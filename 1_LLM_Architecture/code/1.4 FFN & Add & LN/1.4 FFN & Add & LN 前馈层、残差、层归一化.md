# **1.4.1 ä¸‰ä¸ªæ¨¡å—çš„ä½œç”¨**

![](images/image-12.png)

## **FFN å‰é¦ˆå±‚**

> ### **FeedForwardNetworkï¼ŒFFN**
>
> è¿‡äº†MHAä¹‹åï¼Œtokensåªæ˜¯äº’ç›¸æŸ¥çœ‹äº†ä¸€ä¸‹ä¿¡æ¯ï¼Œä½†æ˜¯è¿˜æ²¡æ€è€ƒä»–ä»¬ä»å…¶ä»–tokené‚£é‡Œå‘ç°äº†ä»€ä¹ˆã€‚æ‰€ä»¥**å½“tokené€šè¿‡MHAæŠŠä¿¡æ¯èšé›†èµ·æ¥ä¹‹åï¼Œå†é€šè¿‡å‰é¦ˆç½‘ç»œç‹¬ç«‹çš„å»æ€è€ƒå­¦ä¹ è¿™äº›ä¿¡æ¯ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯äº¤æµåŠ è®¡ç®—**

![](images/image-13.png)

## **Add æ®‹å·®è¿æ¥**

> ### **Residual Add**
>
> **transformerç»“æ„ä¸€èˆ¬ä¼šå †å å¤šä¸ªblockï¼Œäº§ç”Ÿç±»ä¼¼ç¥ç»ç½‘ç»œæ·±åº¦å¢åŠ çš„ä¼˜åŒ–é—®é¢˜**ã€‚**æ®‹å·®é“¾æ¥**æä¾›**æ¢¯åº¦å›ä¼ çš„é«˜é€Ÿå…¬è·¯ï¼Œä¸€å¼€å§‹æ®‹å·®å—çš„å½±å“æ¯”è¾ƒå°ï¼Œè¿™æ ·æ¢¯åº¦ä¹Ÿå¯ä»¥å¾ˆå¥½çš„å›ä¼ åˆ°è¾“å…¥ï¼Œå³ä½¿ç½‘ç»œå¾ˆæ·±ï¼Œéšç€è®­ç»ƒç»§ç»­ï¼Œæ®‹å·®å—çš„æ¢¯åº¦é€æ¸æ‰©å¤§å½±å“**ã€‚åŠ æ³•ä¼šå¹³ç­‰çš„åˆ†æ•£æ¢¯åº¦ã€‚è¿™æ ·çš„è¯ï¼Œè‡³å°‘åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæ¢¯åº¦æ˜¯å¯ä»¥å¾ˆå¥½çš„ä»ç›‘ç£ä¿¡å·å›ä¼ åˆ°è¾“å…¥ï¼Œä»è€Œé¿å…å› ä¸ºå¾ˆæ·±çš„ç½‘ç»œå¯¹ä¼˜åŒ–çš„éš¾åº¦

![](images/image-14.png)

## **Layer Norm å±‚å½’ä¸€åŒ–**

> ### **Layer Norm**
>
> **åŠ é€Ÿæ¨¡å‹æ”¶æ•›ï¼Œç¼“è§£æ¢¯åº¦æ¶ˆå¤±å’Œçˆ†ç‚¸é—®é¢˜ï¼ˆç›¸å…³ï¼šBatch Normï¼Œæ³¨æ„äºŒè€…çš„åŒºåˆ«å’Œåº”ç”¨åœºæ™¯ï¼‰**

![](images/image-10.png)

> ä¸€èˆ¬æ¥è¯´ï¼Œ**Batch Normé€‚ç”¨äºCV**ï¼Œ**Layer Normé€‚ç”¨äºNLP**ã€‚å…³é”®æ˜¯è¦çœ‹éœ€è¦ä¿ç•™ä»€ä¹ˆä¿¡æ¯ï¼Œä¸¾ä¸ªä¾‹å­å°±æ˜ç™½
>
> * NLPä¸­ï¼Œ`['æœæ¨yyds', 'LLMå¤§æ³•å¥½', 'CVæ°¸ä¸ä¸ºå¥´']`ä¸‰å¥è¯åšnormalizationï¼Œå‡è®¾ä¸€ä¸ªè¯æ˜¯ä¸€ä¸ªtokenï¼ŒBatch Normæ•ˆæœæ˜¯`['æœ', 'L', 'C']`, `['æ¨', 'L', 'V']` ...åšå½’ä¸€åŒ–ï¼›Layer Normæ˜¯ä¸‰å¥è¯åˆ†åˆ«å„è‡ªå½’ä¸€åŒ–ï¼›å‰è€…å½’ä¸€åˆ°åŒä¸€åˆ†å¸ƒåå˜æ— æ³•ä¿ç•™ä¸€ä¸ªå¥å­é‡Œçš„åˆ†å¸ƒä¿¡æ¯äº†ï¼ˆæ¯”å¦‚`'æœæ¨yyds'`ç”¨Batch Normåå°±å˜äº†ï¼‰ï¼Œè€ŒLayer Normå¯ä»¥æˆåŠŸä¿ç•™ä¸Šä¸‹æ–‡åˆ†å¸ƒä¿¡æ¯
>
> * ã€äº†è§£å°±è¡Œã€‘CVä¸­Batch Normæ˜¯å¯¹ä¸€ä¸ªå›¾åƒçš„ä¸åŒchannelï¼ˆæ¯”å¦‚RGBé€šé“ï¼‰å„è‡ªè¿›è¡Œå½’ä¸€åŒ–ï¼Œæœ¬èº«CVä»»åŠ¡ä¸éœ€è¦channelä¹‹é—´çš„ä¿¡æ¯äº¤äº’ï¼Œå½’ä¸€åŒ–åä»…ä¿ç•™å„channelçš„åˆ†å¸ƒä¿¡æ¯ä½œåç»­åˆ¤æ–­å³å¯

> ### **å¤šç§Normæ–¹æ³•ç¤ºæ„å›¾**
>
> * **Hï¼ˆHeightï¼‰ï¼š**é«˜åº¦ï¼Œé€šå¸¸æŒ‡å›¾åƒæˆ–ç‰¹å¾å›¾çš„å‚ç›´ç»´åº¦
>
> * **Wï¼ˆWidthï¼‰ï¼š**å®½åº¦ï¼Œé€šå¸¸æŒ‡å›¾åƒæˆ–ç‰¹å¾å›¾çš„æ°´å¹³ç»´åº¦
>
> * **Cï¼ˆChannelï¼‰ï¼š**é€šé“ï¼Œé€šå¸¸æŒ‡å›¾åƒæˆ–ç‰¹å¾å›¾ä¸­çš„é¢œè‰²é€šé“ï¼ˆä¾‹å¦‚ RGB å›¾åƒä¸­çš„çº¢ã€ç»¿ã€è“é€šé“ï¼‰æˆ–ç‰¹å¾é€šé“ï¼ˆä¾‹å¦‚åœ¨å·ç§¯ç¥ç»ç½‘ç»œä¸­çš„ä¸åŒç‰¹å¾å›¾ï¼‰
>
> * **Nï¼ˆNumber of samplesï¼‰ï¼š**æ ·æœ¬æ•°é‡ï¼Œé€šå¸¸æŒ‡æ‰¹æ¬¡ä¸­çš„æ ·æœ¬æ•°é‡ï¼ˆä¾‹å¦‚åœ¨ Batch Norm ä¸­ï¼‰æˆ–å®ä¾‹æ•°é‡ï¼ˆä¾‹å¦‚åœ¨ Instance Norm ä¸­ï¼‰
>
> è¿™äº›ç»´åº¦åœ¨ä¸åŒçš„å½’ä¸€åŒ–æ“ä½œä¸­æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼š
>
> * **Batch Normï¼š**&#x5728;æ‰¹æ¬¡ï¼ˆNï¼‰ç»´åº¦ä¸Šè¿›è¡Œå½’ä¸€åŒ–ï¼Œé€šå¸¸ç”¨äºæ·±åº¦å­¦ä¹ ä¸­çš„æ‰¹é‡å½’ä¸€åŒ–
>
> * **Layer Normï¼š**&#x5728;é€šé“ï¼ˆCï¼‰ç»´åº¦ä¸Šè¿›è¡Œå½’ä¸€åŒ–ï¼Œé€šå¸¸ç”¨äºå¯¹å±‚çš„è¾“å…¥è¿›è¡Œå½’ä¸€åŒ–
>
> * **Instance Normï¼š**&#x5728;é€šé“ï¼ˆCï¼‰å’Œæ ·æœ¬ï¼ˆNï¼‰ç»´åº¦ä¸Šè¿›è¡Œå½’ä¸€åŒ–ï¼Œé€šå¸¸ç”¨äºé£æ ¼è¿ç§»ç­‰ä»»åŠ¡
>
> * **Group Normï¼š**&#x5728;é€šé“ï¼ˆCï¼‰ç»´åº¦ä¸Šè¿›è¡Œåˆ†ç»„å½’ä¸€åŒ–ï¼Œé€šå¸¸ç”¨äºæ›¿ä»£ Batch Norm ä»¥é¿å…æ‰¹æ¬¡å¤§å°å¯¹æ¨¡å‹æ€§èƒ½çš„å½±å“

![](images/image-11.png)

# **1.4.2 Layer Normçš„ä½ç½®å’Œè®¡ç®—**

## **Layer Normçš„ä½ç½®å½±å“**

> ### **Normå‡ºç°åœ¨å„ä¸ªä½ç½®çš„å½±å“**
>
> * **Post-normï¼šæ·±å±‚å®¹æ˜“å‡ºç°è®­ç»ƒä¸ç¨³å®šçš„æƒ…å†µï¼Œæ·±å±‚çš„æ¢¯åº¦èŒƒæ•°é€æ¸å¢å¤§**
>
> * **Pre-normï¼šæ¯å±‚çš„æ¢¯åº¦èŒƒæ•°è¿‘ä¼¼ç›¸ç­‰ï¼Œè®­ç»ƒæ¯”è¾ƒç¨³å®šï¼Œä½†æ˜¯ç‰ºç‰²äº†æ·±åº¦**
>
> * **Sandwich-normï¼šå¹³è¡¡ï¼Œæœ‰æ•ˆæ§åˆ¶æ¯ä¸€å±‚çš„æ¿€æ´»å€¼ï¼Œé¿å…å®ƒä»¬è¿‡å¤§ï¼Œæ¨¡å‹èƒ½å¤Ÿæ›´å¥½åœ°å­¦ä¹ æ•°æ®ç‰¹å¾ï¼Œä½†æ˜¯è®­ç»ƒä¸ç¨³å®šå¯èƒ½å¯¼è‡´å´©æºƒ**
>
> * **Post-Normå’ŒPre- Normçš„å¼‚åŒï¼š**
>
>   * ä¸€èˆ¬è®¤ä¸ºï¼Œ**Post-Normåœ¨æ®‹å·®ä¹‹ååšå½’ä¸€åŒ–ï¼Œå¯¹å‚æ•°æ­£åˆ™åŒ–çš„æ•ˆæœæ›´å¼ºï¼Œè¿›è€Œæ¨¡å‹çš„æ”¶æ•›æ€§ä¹Ÿä¼šæ›´å¥½ï¼›è€ŒPre-Normæœ‰ä¸€éƒ¨åˆ†å‚æ•°ç›´æ¥åŠ åœ¨äº†åé¢ï¼Œæ²¡æœ‰å¯¹è¿™éƒ¨åˆ†å‚æ•°è¿›è¡Œæ­£åˆ™åŒ–ï¼Œå¯ä»¥åœ¨åå‘æ—¶é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸æˆ–è€…æ¢¯åº¦æ¶ˆå¤±**ï¼Œå¤§æ¨¡å‹çš„è®­ç»ƒéš¾åº¦å¤§ï¼Œå› è€Œä½¿**ç”¨Pre-Normè¾ƒå¤š**ã€‚ç›®å‰æ¯”è¾ƒæ˜ç¡®çš„ç»“è®ºæ˜¯ï¼š**åŒä¸€è®¾ç½®ä¹‹ä¸‹ï¼ŒPre-Normç»“æ„å¾€å¾€æ›´å®¹æ˜“è®­ç»ƒï¼Œä½†æœ€ç»ˆæ•ˆæœé€šå¸¸ä¸å¦‚Post Norm**ã€‚ä¸€ä¸ªğ¿å±‚çš„Pre Normæ¨¡å‹ï¼Œå…¶**å®é™…ç­‰æ•ˆå±‚æ•°ä¸å¦‚ğ¿å±‚çš„Post Normæ¨¡å‹**ï¼Œè€Œå±‚æ•°å°‘äº†å¯¼è‡´æ•ˆæœå˜å·®äº†
>
>   * Pre-Normç»“æ„**æ— å½¢åœ°å¢åŠ äº†æ¨¡å‹çš„å®½åº¦è€Œé™ä½äº†æ¨¡å‹çš„æ·±åº¦**ï¼Œè€Œæ·±åº¦é€šå¸¸æ¯”å®½åº¦æ›´é‡è¦ï¼Œæ‰€ä»¥æ˜¯æ— å½¢ä¹‹ä¸­çš„é™ä½æ·±åº¦å¯¼è‡´æœ€ç»ˆæ•ˆæœå˜å·®äº†ã€‚è€ŒPost-Normåˆšåˆšç›¸åï¼Œå®ƒæ¯Normä¸€æ¬¡å°±å‰Šå¼±ä¸€æ¬¡æ’ç­‰åˆ†æ”¯çš„æƒé‡ï¼Œæ‰€ä»¥Post Normåè€Œæ˜¯æ›´çªå‡ºæ®‹å·®åˆ†æ”¯çš„ï¼Œå› æ­¤Post-Normä¸­ä¸€æ—¦è®­ç»ƒå¥½ä¹‹åæ•ˆæœæ›´ä¼˜ï¼Œä½†æ˜¯å› ä¸ºæ®‹å·®æ”¯è·¯è¢«å‰Šå¼±äº†ï¼Œæ‰€ä»¥ä¸€å¼€å§‹ä¸å¥½è®­ç»ƒï¼Œéœ€è¦**warmup**
>
>   * Post normçš„**ä¸ç¨³å®šæ€§ä¸»è¦æ¥è‡ªäºæ¢¯åº¦æ¶ˆå¤±**ï¼Œä»¥åŠåˆå§‹åŒ–æ—¶å€™æ›´æ–°å¤ªå¤§é™·å…¥å±€éƒ¨æœ€ä¼˜
>
>   * è¾“å…¥ç»è¿‡äº†Normä¹‹åï¼ŒåŸºæœ¬ä¸Šèƒ½ä¿æŒåŒä¸€é‡çº§ï¼Œç„¶åAttentionã€MLPè¿™äº›è¿ç®—ï¼Œä¸€èˆ¬ä¸ä¼šå¤§å¹…æ”¹åŠ¨è¾“å…¥æ•°å€¼çš„é‡çº§ï¼ˆå¦åˆ™å®¹æ˜“æ¢¯åº¦æ¶ˆå¤±æˆ–è€…çˆ†ç‚¸ï¼‰ï¼Œå› æ­¤è¾“å‡ºçš„èŒƒå›´ä¹Ÿå¤§è‡´ç›¸åŒ

![](images/image-9.png)

![](images/image-8.png)

## **Layer Normçš„è®¡ç®—**

> ### **Layer Norm**
>
> **å¯¹æ¯ä¸ªæ ·æœ¬çš„æ‰€æœ‰ç‰¹å¾åšå½’ä¸€åŒ–ï¼Œè¿™æ¶ˆé™¤äº†ä¸åŒæ ·æœ¬é—´çš„å¤§å°å…³ç³»ï¼Œä½†æ˜¯ä¿ç•™äº†ä¸€ä¸ªæ ·æœ¬å†…ä¸åŒç‰¹å¾ä¹‹é—´çš„å¤§å°å…³ç³»ã€‚LayerNorm é€‚ç”¨äº NLP é¢†åŸŸï¼Œè¿™æ—¶è¾“å…¥å°ºå¯¸ä¸º $$b\times l\times d$$(æ‰¹é‡å¤§å° x åºåˆ—é•¿åº¦ x åµŒå…¥ç»´åº¦)ï¼Œå…¬å¼å¦‚ä¸‹ï¼Œ**&#x5176;&#x4E2D;**&#x20;**$$\gamma$$å’Œ $$\beta$$æ˜¯**å¯å­¦ä¹ çš„ç¼©æ”¾å’Œåç§»å‚æ•°**
>
> $$\mu = E(X) \leftarrow \frac{1}{H} \sum_{i = 1}^{H} x_i$$
>
> $$\sigma \leftarrow \sqrt{\operatorname{Var}(x)}=\sqrt{\frac{1}{H} \sum_{i = 1}^{H}\left(x_{i}-\mu\right)^{2}+\epsilon}$$
>
> $$y=\frac{x - E(x)}{\sqrt{\operatorname{Var}(X)}} \cdot \gamma+\beta$$

![](images/image-7.png)

> ### **RMS Norm**
>
> å‡æ–¹æ ¹Normï¼Œå…¨ç§°ä¸ºroot mean square layer normalizationï¼Œä¸layer normç›¸æ¯”ï¼ŒRMS Norm **å»é™¤æ‰è®¡ç®—å‡å€¼è¿›è¡Œå¹³ç§»çš„éƒ¨åˆ†**ï¼Œç†è§£æ˜¯æŠŠå‡å€¼çœ‹æˆ0äº†ï¼Œè®¡ç®—é€Ÿåº¦æ›´å¿«æ•ˆæœåŸºæœ¬ç›¸å½“
>
> Layer normé€šè¿‡å¯¹è¾“å…¥è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å…¶å‡å€¼å’Œæ–¹å·®ä¿æŒä¸å˜ã€‚LayerNormæˆåŠŸçš„ä¸€ä¸ªè‘—åè§£é‡Šæ˜¯å…¶é‡æ–°å±…ä¸­å’Œç¼©æ”¾ä¸å˜æ€§å±æ€§ã€‚å‰è€…ä½¿å¾—æ¨¡å‹å¯¹äºè¾“å…¥å’Œæƒé‡ä¸Šçš„åç§»å™ªå£°ä¸æ•æ„Ÿï¼Œè€Œåè€…åœ¨è¾“å…¥å’Œæƒé‡éƒ½è¢«éšæœºç¼©æ”¾æ—¶ä¿æŒè¾“å‡ºè¡¨ç¤ºä¸å˜ï¼Œ**RMS Normä½œè€…å‡è®¾LNçš„æˆåŠŸæ˜¯ç¼©æ”¾ä¸å˜æ€§è€Œä¸æ˜¯é‡æ–°å±…ä¸­**
>
> $$
> RMS(x) = \sqrt{\frac{1}{H} \sum_{i = 1}^{H} x_i^2}
>
> \\
> x = \frac{x}{RMS(x)} \cdot \gamma
>  $$
>
> RMSæµ‹é‡è¾“å…¥çš„å¹³æ–¹å‡å€¼ï¼Œå®ƒ**å°†åŠ æƒå’Œè¾“å…¥å¼ºåˆ¶ç¼©æ”¾åˆ°ä¸€ä¸ª $$\sqrt{n}$$å€çš„å•ä½çƒä¸­**ã€‚é€šè¿‡è¿™æ ·åšï¼Œ**è¾“å‡ºåˆ†å¸ƒä¸å—è¾“å…¥å’Œæƒé‡åˆ†å¸ƒçš„ç¼©æ”¾å½±å“ï¼Œæœ‰åˆ©äºå±‚æ¿€æ´»çš„ç¨³å®šæ€§**ã€‚è™½ç„¶æ¬§å‡ é‡Œå¾—èŒƒæ•°ä¸RMSä»…å·®ä¸€ä¸ª $$\sqrt{n}$$çš„å› å­ï¼Œå·²ç»æˆåŠŸåº”ç”¨äºä¸€äº›é¢†åŸŸï¼Œä½†ç»éªŒè¯æ˜ï¼Œå®ƒåœ¨å±‚å½’ä¸€åŒ–ä¸­å¹¶ä¸å¥æ•ˆ
>
> ### **Deep Norm**
>
> å¯ä»¥ç¼“è§£ Transformer è¿‡æ·±å¯¼è‡´çˆ†ç‚¸å¼æ¨¡å‹æ›´æ–°è®­ç»ƒä¸ç¨³å®šçš„é—®é¢˜ï¼ŒæŠŠæ¨¡å‹æ›´æ–°é™åˆ¶åœ¨å¸¸æ•°ï¼Œä½¿å¾—æ¨¡å‹è®­ç»ƒè¿‡ç¨‹æ›´ç¨³å®šã€‚Deep Normæ–¹æ³•åœ¨**æ‰§è¡ŒLayer Normä¹‹å‰ï¼Œup-scaleäº†æ®‹å·®è¿æ¥(alpha>1)å¦å¤–ï¼Œåœ¨åˆå§‹åŒ–é˜¶æ®µdown-scaleäº†æ¨¡å‹å‚æ•°(beta<1)**
>
> 1. ä½¿ç”¨ DeepNorm æ—¶ï¼Œæ‹¿å®ƒæ¥æ›¿æ¢ Post-LN
>
> 2. DeepNorm å…¶å®å°±æ˜¯ LNï¼Œåªæ˜¯åœ¨æ‰§è¡Œå±‚å½’ä¸€åŒ–ä¹‹å‰ up-scale äº†æ®‹å·®è¿æ¥ã€‚ $$xâˆ—Î± + f(x) $$é‡Œé¢çš„ $$f(x)$$ ä»£è¡¨ Self-Attention ç­‰ç­‰çš„ Token-mixerï¼Œx ä»£è¡¨ Token-mixer çš„è¾“å‡ºï¼ŒÎ± æ˜¯å¸¸æ•°
>
> 3. `torch.nn.init.xavier_normal_(tensor, gain=1)`æ˜¯ xavier é«˜æ–¯åˆå§‹åŒ–ï¼Œå‚æ•°ç”±0å‡å€¼ï¼Œæ ‡å‡†å·®ä¸º`  gain Ã— sqrt(2 / (fan_in + fan_out))  `çš„æ­£æ€åˆ†å¸ƒäº§ç”Ÿï¼Œå…¶ä¸­`fan_in` å’Œ `fan_out `æ˜¯åˆ†åˆ«æƒå€¼å¼ é‡çš„è¾“å…¥å’Œè¾“å‡ºå…ƒç´ æ•°ç›®ã€‚ è¿™ç§åˆå§‹åŒ–åŒæ ·æ˜¯ä¸ºäº†ä¿è¯**è¾“å…¥è¾“å‡ºçš„æ–¹å·®ä¸å˜**
>
> $$std=gainÃ—\sqrt{\frac{2}{fan\_in+fan\_out}}$$
>
> * DeepNorm è¿˜åœ¨åˆå§‹åŒ–æœŸé—´ down-scale äº†å‚æ•°ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¯¹äº `ffnï¼Œv_projï¼Œout_proj`å’Œ `q_projï¼Œk_proj`çš„åˆå§‹åŒ–ï¼Œæ˜¯ä¸ä¸€æ ·çš„
>
> * ä¸åŒæ¶æ„çš„ Î± å’Œ Î² å€¼ä¸ä¸€æ ·
>
> > **å¯¼è‡´è®­ç»ƒä¸ç¨³å®šçš„åŸå› **
> >
> > 1. è®­ç»ƒçš„**èµ·å§‹é˜¶æ®µæ¨¡å‹å‚æ•°æ›´æ–°éå¸¸å¿«**ï¼Œå®ƒä½¿æ¨¡å‹é™·å…¥ä¸€ä¸ªåçš„å±€éƒ¨æœ€ä¼˜ï¼Œè¿™åè¿‡æ¥å¢åŠ äº†æ¯ä¸ª LN çš„è¾“å…¥
> >
> > 2. Pre-LNåœ¨åº•å±‚çš„æ¢¯åº¦å¾€å¾€å¤§äºé¡¶å±‚

## **Batch Normçš„è®¡ç®—**

> * **BatchNorm**æ˜¯å¯¹æ•´ä¸ª batch æ ·æœ¬å†…çš„æ¯ä¸ªç‰¹å¾åšå½’ä¸€åŒ–ï¼Œè¿™æ¶ˆé™¤äº†ä¸åŒç‰¹å¾ä¹‹é—´çš„å¤§å°å…³ç³»ï¼Œä½†æ˜¯ä¿ç•™äº†ä¸åŒæ ·æœ¬é—´çš„å¤§å°å…³ç³»ã€‚BatchNorm é€‚ç”¨äº CV é¢†åŸŸï¼Œè¿™æ—¶è¾“å…¥å°ºå¯¸ä¸º  $$b\times c\times h\times w$$ (æ‰¹é‡å¤§å°xé€šé“xé•¿xå®½)ï¼Œå›¾åƒçš„æ¯ä¸ªé€šé“ c çœ‹ä½œä¸€ä¸ªç‰¹å¾ï¼ŒBN å¯ä»¥æŠŠå„é€šé“ç‰¹å¾å›¾çš„æ•°é‡çº§è°ƒæ•´åˆ°å·®ä¸å¤šï¼ŒåŒæ—¶ä¿æŒä¸åŒå›¾ç‰‡ç›¸åŒé€šé“ç‰¹å¾å›¾é—´çš„ç›¸å¯¹å¤§å°å…³ç³»
>
> * åœ¨trainæ¨¡å¼ä¸‹å‚æ•°ä¼šéšç€ç½‘ç»œçš„åå‘ä¼ æ’­è¿›è¡Œæ¢¯åº¦æ›´æ–°ï¼Œè®¡ç®—æ¯ä¸€ä¸ªbatché‡Œçš„æ–¹å·®å’Œå¹³å‡å€¼ï¼Œåœ¨evalæ¨¡å¼ï¼Œæ¨¡å‹ä¸å¯èƒ½ç­‰åˆ°é¢„æµ‹æ ·æœ¬æ•°é‡è¾¾åˆ°ä¸€ä¸ªbatchæ—¶ï¼Œå†è¿›è¡Œå½’ä¸€åŒ–ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨trainæ¨¡å¼å¾—åˆ°çš„ç»Ÿè®¡é‡

![](images/image-5.png)

**BNå’ŒLNçš„åŒºåˆ«**

# **1.4.4 FFNè®¡ç®—å’Œæ¿€æ´»å‡½æ•°**

> ### **FFNå—è®¡ç®—**
>
> * **ä¸€èˆ¬æ¿€æ´»å‡½æ•°è®¡çš„FFNå—ç®—å…¬å¼ï¼š** $$FFN(x) = ReLU(xW_1+b1)W_2+b_2$$
>
> * **GLUçº¿æ€§é—¨æ§å•å…ƒçš„FFNå—è®¡ç®—å…¬å¼ï¼š**
>
>   $$GLU(x) = xV \cdot \sigma(xW + b)\ \ \ 
>   FFN_{GLU} = (xV \cdot \sigma(xW_1 + b))W_2$$
>
>   è¾“å‡ºä¸¤ä¸ªçº¿æ€§å˜æ¢ï¼Œç„¶åå¯¹ä¸€ä¸ªåšsigmoidï¼Œä¹˜ä»¥çº¿æ€§å˜æ¢çš„ï¼Œ**ç›¸å½“äºåšäº†é—¨æ§æœºåˆ¶**ï¼Œé€‰æ‹©å“ªäº›è¿‡ï¼Œå“ªäº›ä¸è¿‡ï¼Œ**è¿›è¡Œäº†ä¿¡æ¯è¿‡æ»¤ï¼Œå¤„ç†ä¿¡æ¯æ—¶æ›´æœ‰é’ˆå¯¹æ€§ï¼Œå¢å¼ºè¡¨è¾¾èƒ½åŠ›**
>
>   **SwiGLUã€GeGLU**å°±æ˜¯ç”¨**Swishã€GeLUæ¿€æ´»å‡½æ•°**åˆ†åˆ«å»**æ›¿æ¢GLUä¸­çš„sigmoidæ¿€æ´»å‡½æ•°ã€‚ä¸€ä¸ªä¾‹å­**ï¼šåœ¨LLaMA2-7Bä¸­ï¼ŒFFNçš„åŸå§‹è¾“å…¥ç»´åº¦ä¸º4096ï¼Œä¸€èˆ¬è€Œè¨€**ä¸­é—´å±‚æ˜¯è¾“å…¥ç»´åº¦çš„4å€ç­‰äº16384**ï¼Œç”±äºSwiGLUçš„åŸå› **FFNä»2ä¸ªçŸ©é˜µå˜æˆ3ä¸ªçŸ©é˜µ**ï¼Œä¸ºäº†ä½¿å¾—æ¨¡å‹çš„å‚æ•°é‡å¤§ä½“ä¿æŒä¸å˜ï¼Œ**ä¸­é—´å±‚ç»´åº¦åšäº†ç¼©å‡ï¼Œç¼©å‡ä¸ºåŸæ¥çš„2/3å³10922ï¼Œè¿›ä¸€æ­¥ä¸ºäº†ä½¿å¾—ä¸­é—´å±‚æ˜¯256çš„æ•´æ•°å€ï¼Œåˆåšäº†å–æ¨¡å†è¿˜åŸçš„æ“ä½œï¼Œæœ€ç»ˆä¸­é—´å±‚ç»´åº¦ä¸º11008**
>
> * **Swishæ¿€æ´»å‡½æ•°ï¼š** $$Swish(x) = x \times sigmoid(\beta * x)$$
>
> * **GeLUæ¿€æ´»å‡½æ•°ï¼š** $$GeLU(x) \approx 0.5x\left(1 + tanh\left(\sqrt{\frac{2}{\pi}}\left(x + 0.044715x^{3}\right)\right)\right)$$
>
> * ç°åœ¨å¤§æ¨¡å‹**é€šå¸¸ä½¿ç”¨SwiGLUæ›¿æ¢æ‰ä¼ ç»Ÿçš„FFNç»“æ„**

![](images/image-6.png)

**ä¸€èˆ¬æ¿€æ´»å‡½æ•°**

![](images/image-3.png)

**GLU**

# **1.4.5 å¸¸è§æ¿€æ´»å‡½æ•°å…¬å¼åŠå›¾ç¤º**

## **Sigmoid**

> **ç¼ºç‚¹ï¼š**
>
> * **è¾“å…¥è¾ƒå¤§æˆ–è¾ƒå°æ—¶å€™æ¢¯åº¦æ¥è¿‘äº0ï¼Œå®¹æ˜“å¯¼è‡´æ¢¯åº¦æ¶ˆå¤±**
>
> * **å‡½æ•°è¾“å‡ºä¸æ˜¯ä»¥ 0 ä¸ºä¸­å¿ƒçš„ï¼Œæ¢¯åº¦å¯èƒ½å°±ä¼šå‘ç‰¹å®šæ–¹å‘ç§»åŠ¨ï¼Œä»è€Œé™ä½æƒé‡æ›´æ–°çš„æ•ˆç‡**
>
> * **Sigmoid å‡½æ•°æ‰§è¡ŒæŒ‡æ•°è¿ç®—ï¼Œè®¡ç®—æœºè¿è¡Œå¾—è¾ƒæ…¢ï¼Œæ¯”è¾ƒæ¶ˆè€—è®¡ç®—èµ„æº**
>
>   $$f(x) = \frac{1}{1+e^{-x}}\\
>   f'(x) = f(x)f(1-x)$$

![](images/image-4.png)



## **Tanh**

> **ä¼˜ç‚¹ï¼štanh**æ˜¯â€œé›¶ä¸ºä¸­å¿ƒâ€çš„ã€‚å› æ­¤åœ¨å®é™…åº”ç”¨ä¸­ï¼Œtanhä¼šæ¯”sigmoidæ›´å¥½ä¸€äº›
>
> **ç¼ºç‚¹ï¼š**
>
> * **ä»ç„¶å­˜åœ¨æ¢¯åº¦é¥±å’Œçš„é—®é¢˜**
>
> * **ä¾ç„¶è¿›è¡Œçš„æ˜¯æŒ‡æ•°è¿ç®—**
>
> $$f(x)=\frac{e^{x}-e^{-x}}{e^{x}+e^{-x}}$$

![](images/image-1.png)

## **ReLU**

> **ä¼˜ç‚¹ï¼š**
>
> * **ReLUè§£å†³äº†æ¢¯åº¦æ¶ˆå¤±çš„é—®é¢˜ï¼Œå½“è¾“å…¥å€¼ä¸ºæ­£æ—¶ï¼Œç¥ç»å…ƒä¸ä¼šé¥±å’Œ**
>
> * **ç”±äºReLUçº¿æ€§ã€éé¥±å’Œçš„æ€§è´¨ï¼Œåœ¨SGDä¸­èƒ½å¤Ÿå¿«é€Ÿæ”¶æ•›**
>
> * **è®¡ç®—å¤æ‚åº¦ä½ï¼Œä¸éœ€è¦è¿›è¡ŒæŒ‡æ•°è¿ç®—**
>
> **ç¼ºç‚¹ï¼š**
>
> * **ä¸Sigmoidä¸€æ ·ï¼Œå…¶è¾“å‡ºä¸æ˜¯ä»¥0ä¸ºä¸­å¿ƒçš„**
>
> * **Dead ReLU é—®é¢˜ã€‚å½“è¾“å…¥ä¸ºè´Ÿæ—¶ï¼Œæ¢¯åº¦ä¸º0ã€‚è¿™ä¸ªç¥ç»å…ƒåŠä¹‹åçš„ç¥ç»å…ƒæ¢¯åº¦æ°¸è¿œä¸º0ï¼Œä¸å†å¯¹ä»»ä½•æ•°æ®æœ‰æ‰€å“åº”ï¼Œå¯¼è‡´ç›¸åº”å‚æ•°æ°¸è¿œä¸ä¼šè¢«æ›´æ–°**
>
> $$f(x) = \max(0,x)$$





![](images/image.png)

## **Leaky ReLU**

> **ä¼˜ç‚¹ï¼š**
>
> * **è§£å†³äº†ReLUè¾“å…¥å€¼ä¸ºè´Ÿæ—¶ç¥ç»å…ƒå‡ºç°çš„æ­»äº¡çš„é—®é¢˜**
>
> * **Leaky ReLUçº¿æ€§ã€éé¥±å’Œçš„æ€§è´¨ï¼Œåœ¨SGDä¸­èƒ½å¤Ÿå¿«é€Ÿæ”¶æ•›**
>
> * **è®¡ç®—å¤æ‚åº¦ä½ï¼Œä¸éœ€è¦è¿›è¡ŒæŒ‡æ•°è¿ç®—**
>
> **ç¼ºç‚¹ï¼š**
>
> * **å‡½æ•°ä¸­çš„Î±ï¼Œéœ€è¦é€šè¿‡å…ˆéªŒçŸ¥è¯†äººå·¥èµ‹å€¼ï¼ˆä¸€èˆ¬è®¾ä¸º0.01ï¼‰**
>
> * **æœ‰äº›è¿‘ä¼¼çº¿æ€§ï¼Œå¯¼è‡´åœ¨å¤æ‚åˆ†ç±»ä¸­æ•ˆæœä¸å¥½**
>
> $$f(x)=\max(\alpha x, x)$$



![](images/image-2.png)

## **ELU**

> **ä¼˜ç‚¹ï¼š**
>
> * **ELUè¯•å›¾å°†æ¿€æ´»å‡½æ•°çš„è¾“å‡ºå‡å€¼æ¥è¿‘äºé›¶ï¼Œä½¿æ­£å¸¸æ¢¯åº¦æ›´æ¥è¿‘äºå•ä½è‡ªç„¶æ¢¯åº¦ï¼Œä»è€ŒåŠ å¿«å­¦ä¹ é€Ÿåº¦**
>
> * **ELU åœ¨è¾ƒå°çš„è¾“å…¥ä¸‹ä¼šé¥±å’Œè‡³è´Ÿå€¼ï¼Œä»è€Œå‡å°‘å‰å‘ä¼ æ’­çš„å˜å¼‚å’Œä¿¡æ¯**
>
> **ç¼ºç‚¹ï¼š**
>
> * **è®¡ç®—çš„æ—¶éœ€è¦è®¡ç®—æŒ‡æ•°ï¼Œè®¡ç®—æ•ˆç‡ä½**
>
> $$f(\alpha,x)=\begin{cases}
> \alpha(e^{x}-1), & \text{for } x \leq 0 \\
> x, & \text{for } x > 0
> \end{cases}$$



![](images/image-17.png)

## **Swish**

> **ä¼˜ç‚¹ï¼š**
>
> **Swishç›¸è¾ƒäºä¼ ç»Ÿçš„ReLUæ¿€æ´»å‡½æ•°ï¼Œå…·æœ‰å…‰æ»‘çš„éå•è°ƒç‰¹æ€§ï¼Œå…¶æ— ç•Œæ€§æœ‰åŠ©äºé˜²æ­¢æ…¢é€Ÿè®­ç»ƒæœŸé—´ï¼Œæ¢¯åº¦é€æ¸æ¥è¿‘ 0 å¹¶å¯¼è‡´é¥±å’Œ**ï¼›åŒæ—¶ï¼Œæœ‰ç•Œæ€§ä¹Ÿæ˜¯æœ‰ä¼˜åŠ¿çš„ï¼Œå› ä¸º**æœ‰ç•Œæ¿€æ´»å‡½æ•°å¯ä»¥å…·æœ‰å¾ˆå¼ºçš„æ­£åˆ™åŒ–**(é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œ è¿›è€Œå¢å¼ºæ³›åŒ–èƒ½åŠ›)ï¼Œå¹¶ä¸”**è¾ƒå¤§çš„è´Ÿè¾“å…¥é—®é¢˜ä¹Ÿèƒ½è§£å†³**ã€‚Swishæ¿€æ´»å‡½æ•°åœ¨x=0é™„è¿‘æ›´ä¸ºå¹³æ»‘ï¼Œè€Œéå•è°ƒçš„ç‰¹æ€§å¢å¼ºäº†è¾“å…¥æ•°æ®å’Œè¦å­¦ä¹ çš„æƒé‡çš„è¡¨è¾¾èƒ½åŠ›
>
> $$f(x) = x * \text{sigmoid}(\beta x)$$
>
> * å½“ $$\beta \rightarrow0$$æ—¶ï¼ŒSwishæ¥è¿‘äºçº¿æ€§å‡½æ•°
>
> * å½“ $$\beta \rightarrow \infty$$æ—¶ï¼Œå®ƒæ¥è¿‘ReLU
>
> * å½“ $$\beta=1$$æ—¶ï¼ŒSwishä¸SiLUç­‰ä»·
>
> Swishçš„ä¼˜åŠ¿åœ¨äºå…¶å¯¹è´Ÿå€¼çš„è¾“å…¥æœ‰ä¸€å®šçš„æ¿€æ´»





![](images/image-16.png)



## **Softmax**

> **Softmax**å‡½æ•°å¸¸åœ¨ç¥ç»ç½‘ç»œè¾“å‡ºå±‚å……å½“æ¿€æ´»å‡½æ•°ï¼Œå°†è¾“å‡ºå±‚çš„å€¼é€šè¿‡æ¿€æ´»å‡½æ•°æ˜ å°„åˆ°0-1åŒºé—´ï¼Œå°†ç¥ç»å…ƒè¾“å‡ºæ„é€ æˆæ¦‚ç‡åˆ†å¸ƒï¼Œç”¨äºå¤šåˆ†ç±»é—®é¢˜ä¸­ï¼ŒSoftmaxæ¿€æ´»å‡½æ•°æ˜ å°„å€¼è¶Šå¤§ï¼Œåˆ™çœŸå®ç±»åˆ«å¯èƒ½æ€§è¶Šå¤§
>
> $$f(x) = \frac{e^x}{\sum_i^Ne^{x_i}}$$



![](images/image-15.png)

